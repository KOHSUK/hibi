# データベース設計共通ガイドライン

## 前提と目的

- バックエンドは境界づけられたコンテキスト単位のモジュールで構成し、ドメインモデルの独立性を維持する。
- 各モジュールは単一のデータベーススキーマ（以下、スキーマ）を専有し、スキーマはそのモジュールのデータ整合性を守る境界とする。
- マイクロサービスに近い疎結合を実現しつつ、デプロイメントやオペレーションの複雑性はモノリシックな構成で抑える。

## スキーマ命名と所有権

- スキーマ名はモジュール名（境界づけられたコンテキスト名）を基にし、`snake_case` で定義する（例: `task_manager`、`accounting`）。
- スキーマはモジュールが唯一の所有者となる。他モジュールは直接テーブルを更新してはならず、読み取りも原則禁止とする。
- 共通ユーティリティ的なテーブルが必要な場合は、明示的な `shared` コンテキストを定義し、そのスキーマを経由する。

## アクセスルール

- 各モジュールの永続化レイヤーは自スキーマ内のテーブルのみを直接参照する。
- 他モジュールのデータが必要な場合は、アプリケーション層を介した公開 API やドメインイベントを利用して同期／非同期に取得する。
- レポート用途などでクロススキーマの read-only 参照が必要な場合は、専用のリードモデルやマテリアライズドビューを別スキーマ（例: `reporting`）に作成し、所有者が運用する。

## マイグレーション指針

- マイグレーションファイルは `db/migrations/<context>/` に配置し、ファイル名に昇順ソート可能なタイムスタンプを付与する（例: `20241005_add_tasks_table.sql`）。
- マイグレーションはモジュールごとに粒度を揃え、同一コミット内でアプリケーションコードと整合するようにする。
- スキーマ作成・変更時は所有モジュールのレビューを必須とし、他モジュールに影響する場合は影響範囲を設計文書に追記する。

## トランザクションと整合性

- トランザクションは自モジュールのスキーマに閉じる。複数スキーマに跨る ACID トランザクションは禁止とし、最終的整合性を前提にする。
- 例外的にクロススキーマの整合性が必要な場合は、アプリケーション層でのサガ／アウトボックスパターンなどを検討し、設計レビューを通過させる。

## インデックスと性能

- インデックスや制約は各モジュールが責任を持って管理し、パフォーマンス要件はモジュール内で完結させる。
- グローバルに影響する構成変更（例: DB パラメータの変更）は SRE/プラットフォーム担当経由で合意形成する。

## ドキュメント整備

- 各モジュールはスキーマ構造とテーブル説明を `docs/design/db/<context>-schema.md` にまとめ、ドメインの変更に合わせて更新する。
- モジュール横断のルール変更やパターン追加が生じた場合は、本ガイドラインを更新し、変更履歴と導入背景を明記する。
